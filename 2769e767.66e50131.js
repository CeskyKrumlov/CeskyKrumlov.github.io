(window.webpackJsonp=window.webpackJsonp||[]).push([[84],{140:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return c})),n.d(t,"rightToc",(function(){return o})),n.d(t,"default",(function(){return d}));var a=n(2),l=n(6),r=(n(0),n(570)),i={id:"24.threadLocal",title:"ThreadLocal",hide_title:!0},c={unversionedId:"juc/24.threadLocal",id:"juc/24.threadLocal",isDocsHomePage:!1,title:"ThreadLocal",description:"ThreadLocal",source:"@site/docs/juc/24.threadlocal.md",slug:"/juc/24.threadLocal",permalink:"/docs/juc/24.threadLocal",version:"current",sidebar:"someSidebar",previous:{title:"AQS",permalink:"/docs/juc/23.aqs"},next:{title:"JDBC",permalink:"/docs/javaweb/3.jdbc"}},o=[{value:"ThreadLocal",id:"threadlocal",children:[{value:"Thread\u3001ThreadLocal\u3001ThreadLocalMap\u3001Entry",id:"thread\u3001threadlocal\u3001threadlocalmap\u3001entry",children:[{value:"\u5f3a\u5f15\u7528\u4e0e\u5f31\u5f15\u7528",id:"\u5f3a\u5f15\u7528\u4e0e\u5f31\u5f15\u7528",children:[]}]},{value:"ThreadLocal \u5185\u5b58\u7ed3\u6784\u56fe",id:"threadlocal-\u5185\u5b58\u7ed3\u6784\u56fe",children:[{value:"\u5185\u5b58\u6cc4\u6f0f",id:"\u5185\u5b58\u6cc4\u6f0f",children:[]},{value:"ThreadLocal remove() \u65b9\u6cd5",id:"threadlocal-remove-\u65b9\u6cd5",children:[]},{value:"set \u65b9\u6cd5\u56de\u6536\u7a7a\u95f4",id:"set-\u65b9\u6cd5\u56de\u6536\u7a7a\u95f4",children:[]},{value:"get \u65b9\u6cd5\u56de\u6536\u7a7a\u95f4",id:"get-\u65b9\u6cd5\u56de\u6536\u7a7a\u95f4",children:[]},{value:"\u5f31\u5f15\u7528\u53ef\u4ee5\u89e3\u51b3\u5185\u5b58\u6cc4\u6f0f\u95ee\u9898\u5417",id:"\u5f31\u5f15\u7528\u53ef\u4ee5\u89e3\u51b3\u5185\u5b58\u6cc4\u6f0f\u95ee\u9898\u5417",children:[]}]},{value:"Hash \u8ba1\u7b97\u4e0e Hash \u51b2\u7a81",id:"hash-\u8ba1\u7b97\u4e0e-hash-\u51b2\u7a81",children:[{value:"\u8ba1\u7b97\u7d22\u5f15",id:"\u8ba1\u7b97\u7d22\u5f15",children:[]},{value:"\u5f00\u653e\u5b9a\u5740\u6cd5\u2014\u2014\u7ebf\u6027\u63a2\u6d4b\u5904\u7406\u54c8\u5e0c\u51b2\u7a81",id:"\u5f00\u653e\u5b9a\u5740\u6cd5\u7ebf\u6027\u63a2\u6d4b\u5904\u7406\u54c8\u5e0c\u51b2\u7a81",children:[]}]}]},{value:"Spring @Transaction \u4e0e ThreadLocal",id:"spring-transaction-\u4e0e-threadlocal",children:[]},{value:"\u4f7f\u7528 ThreadLocal \u7684\u573a\u666f",id:"\u4f7f\u7528-threadlocal-\u7684\u573a\u666f",children:[]},{value:"\u9762\u8bd5\u9898",id:"\u9762\u8bd5\u9898",children:[{value:"1\u3001\u548cSynchronized\u7684\u533a\u522b",id:"1\u3001\u548csynchronized\u7684\u533a\u522b",children:[]},{value:"2\u3001\u5b58\u50a8\u5728jvm\u7684\u54ea\u4e2a\u533a\u57df",id:"2\u3001\u5b58\u50a8\u5728jvm\u7684\u54ea\u4e2a\u533a\u57df",children:[]},{value:"3\u3001\u771f\u7684\u53ea\u662f\u5f53\u524d\u7ebf\u7a0b\u53ef\u89c1\u5417",id:"3\u3001\u771f\u7684\u53ea\u662f\u5f53\u524d\u7ebf\u7a0b\u53ef\u89c1\u5417",children:[]},{value:"4\u3001\u4f1a\u5bfc\u81f4\u5185\u5b58\u6cc4\u6f0f\u4e48",id:"4\u3001\u4f1a\u5bfc\u81f4\u5185\u5b58\u6cc4\u6f0f\u4e48",children:[]},{value:"5\u3001\u4e3a\u4ec0\u4e48\u7528Entry\u6570\u7ec4\u800c\u4e0d\u662fEntry\u5bf9\u8c61",id:"5\u3001\u4e3a\u4ec0\u4e48\u7528entry\u6570\u7ec4\u800c\u4e0d\u662fentry\u5bf9\u8c61",children:[]},{value:"6\u3001\u4f60\u5b66\u4e60\u7684\u5f00\u6e90\u6846\u67b6\u54ea\u4e9b\u7528\u5230\u4e86ThreadLocal",id:"6\u3001\u4f60\u5b66\u4e60\u7684\u5f00\u6e90\u6846\u67b6\u54ea\u4e9b\u7528\u5230\u4e86threadlocal",children:[]},{value:"7\u3001ThreadLocal\u91cc\u7684\u5bf9\u8c61\u4e00\u5b9a\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\u5417",id:"7\u3001threadlocal\u91cc\u7684\u5bf9\u8c61\u4e00\u5b9a\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\u5417",children:[]}]}],b={rightToc:o};function d(e){var t=e.components,i=Object(l.a)(e,["components"]);return Object(r.b)("wrapper",Object(a.a)({},b,i,{components:t,mdxType:"MDXLayout"}),Object(r.b)("br",null),Object(r.b)("h1",{id:"threadlocal"},"ThreadLocal"),Object(r.b)("p",null,"\u7ebf\u7a0b\u79c1\u6709\u7684\u5b58\u50a8\u6570\u636e\u7ed3\u6784\uff0c\u5e95\u5c42\u662f Map"),Object(r.b)("h2",{id:"thread\u3001threadlocal\u3001threadlocalmap\u3001entry"},"Thread\u3001ThreadLocal\u3001ThreadLocalMap\u3001Entry"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java",metastring:'title="set \u65b9\u6cd5"',title:'"set','\u65b9\u6cd5"':!0}),"/**\n* Sets the current thread's copy of this thread-local variable\n* to the specified value.  Most subclasses will have no need to\n* override this method, relying solely on the {@link #initialValue}\n* method to set the values of thread-locals.\n*\n* @param value the value to be stored in the current thread's copy of\n*        this thread-local.\n*/\npublic void set(T value) {\n    Thread t = Thread.currentThread(); // \u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\n    ThreadLocalMap map = getMap(t); // \u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\u5bf9\u5e94\u7684 Map\n    if (map != null)\n        map.set(this, value);\n    else\n        createMap(t, value);\n}\n")),Object(r.b)("p",null,Object(r.b)("inlineCode",{parentName:"p"},"Set()")," \u65b9\u6cd5\u4e2d\u4f7f\u7528\u4e86 ",Object(r.b)("inlineCode",{parentName:"p"},"getMap(thread)")," \u65b9\u6cd5\u83b7\u53d6\u7ebf\u7a0b\u5bf9\u5e94\u7684 Map\uff0c\u518d\u770b ",Object(r.b)("inlineCode",{parentName:"p"},"getMap(thread)")," \u65b9\u6cd5\u7684\u6e90\u7801"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java",metastring:'title="getMap \u65b9\u6cd5"',title:'"getMap','\u65b9\u6cd5"':!0}),"/**\n* Get the map associated with a ThreadLocal. Overridden in\n* InheritableThreadLocal.\n*\n* @param  t the current thread\n* @return the map\n*/\nThreadLocalMap getMap(Thread t) {\n    return t.threadLocals;\n}\n")),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"\u663e\u7136\uff0cthreadLocals \u662f\u7ebf\u7a0b\u7c7b Thread \u7684\u4e00\u4e2a\u6210\u5458\u53d8\u91cf")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java",metastring:'title="Thread \u7c7b\u4e2d\u7684 threadLocals"',title:'"Thread',"\u7c7b\u4e2d\u7684":!0,'threadLocals"':!0}),"/* ThreadLocal values pertaining to this thread. This map is maintained\n* by the ThreadLocal class. */\nThreadLocal.ThreadLocalMap threadLocals = null;\n")),Object(r.b)("p",null,"\u7c7b\u578b\u662f ",Object(r.b)("inlineCode",{parentName:"p"},"ThreadLocal.ThreadLocalMap"),"\uff0c\u5176\u5b9e ThreadLocal \u4e2d\u7684\u4e00\u4e2a\u5b50\u7c7b"),Object(r.b)("div",{className:"admonition admonition-info alert alert--info"},Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(r.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(r.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})))),"\u4e3a\u4ec0\u4e48 ThreadLocal \u53ef\u4ee5\u89e3\u51b3\u7ebf\u7a0b\u5b89\u5168\u95ee\u9898")),Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(r.b)("p",{parentName:"div"},"\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u5df2\u7ecf\u53ef\u4ee5\u770b\u5230\uff0cThreadLocal \u662f\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u6709\u4e00\u4e2a\u81ea\u5df1\u7684 Map \u6765\u5b58\u50a8\u6570\u636e\uff0c\u5b58\u50a8\u7684\u5730\u65b9\u662f\u5206\u5f00\u7684"))),Object(r.b)("p",null,"\u518d\u770b ThreadLocalMap \u7684\u6e90\u7801\uff0c\u53d1\u73b0\u4e0b\u9762\u6709\u4e2a\u5b50\u7c7b ",Object(r.b)("inlineCode",{parentName:"p"},"Entry")," \u5c31\u662f ThreadLocalMap \u4e2d\u5b58\u50a8\u7684\u5b9e\u4f53"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java",metastring:'title="ThreadLocalMap"',title:'"ThreadLocalMap"'}),'static class ThreadLocalMap {\n\n    /**\n * The entries in this hash map extend WeakReference, using\n * its main ref field as the key (which is always a\n * ThreadLocal object).  Note that null keys (i.e. entry.get()\n * == null) mean that the key is no longer referenced, so the\n * entry can be expunged from table.  Such entries are referred to\n * as "stale entries" in the code that follows.\n */\n    static class Entry extends WeakReference<ThreadLocal<?>> {\n        /** The value associated with this ThreadLocal. */\n        Object value;\n\n        Entry(ThreadLocal<?> k, Object v) {\n            super(k);\n            value = v;\n        }\n    }\n\n    /**\n         * The initial capacity -- MUST be a power of two.\n         */\n    private static final int INITIAL_CAPACITY = 16;\n\n    /**\n         * The table, resized as necessary.\n         * table.length MUST always be a power of two.\n         */\n    private Entry[] table;\n\n    /**\n         * The number of entries in the table.\n         */\n    private int size = 0;\n\n    /**\n         * The next size value at which to resize.\n         */\n    private int threshold; // Default to 0\n\n    /**\n         * Set the resize threshold to maintain at worst a 2/3 load factor.\n         */\n    private void setThreshold(int len) {\n        threshold = len * 2 / 3;\n    }\n    \n    // .....\n}\n')),Object(r.b)("p",null,Object(r.b)("inlineCode",{parentName:"p"},"Entry")," \u7ee7\u627f\u4e86 ",Object(r.b)("inlineCode",{parentName:"p"},"WeakReference<ThreadLocal<?>>")," \u5f31\u5f15\u7528"),Object(r.b)("h3",{id:"\u5f3a\u5f15\u7528\u4e0e\u5f31\u5f15\u7528"},"\u5f3a\u5f15\u7528\u4e0e\u5f31\u5f15\u7528"),Object(r.b)("blockquote",null,Object(r.b)("h3",Object(a.a)({parentName:"blockquote"},{id:"\u5f31\u5f15\u7528\u4e0e\u5f3a\u5f15\u7528\u7684\u533a\u522b"}),"\u5f31\u5f15\u7528\u4e0e\u5f3a\u5f15\u7528\u7684\u533a\u522b"),Object(r.b)("ul",{parentName:"blockquote"},Object(r.b)("li",{parentName:"ul"},"\u5f3a\u5f15\u7528",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"\u5f15\u7528 -> \u5bf9\u8c61")),Object(r.b)("li",{parentName:"ul"},"\u5728 GC \u65f6\u4e0d\u4f1a\u88ab\u56de\u6536\uff0c\u53ea\u6709\u5f53 ",Object(r.b)("inlineCode",{parentName:"li"},"\u5f15\u7528 -> null"),"\uff0c\u6839\u636e\u53ef\u8fbe\u6027\u5206\u6790\uff0c\u843d\u7a7a\u7684\u5bf9\u8c61\u624d\u4f1a\u88ab GC \u56de\u6536"))),Object(r.b)("li",{parentName:"ul"},"\u5f31\u5f15\u7528",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"\u5f15\u7528 -> WeakReference\u5f31\u5f15\u7528\u5bf9\u8c61 \u2026\u2026> \u771f\u5b9e\u5bf9\u8c61")),Object(r.b)("li",{parentName:"ul"},"\u4e00\u65e6 GC\uff0c\u5219 ",Object(r.b)("inlineCode",{parentName:"li"},"WeakReference\u5f31\u5f15\u7528\u5bf9\u8c61")," \u5230 ",Object(r.b)("inlineCode",{parentName:"li"},"\u771f\u5b9e\u5bf9\u8c61")," \u7684\u5f15\u7528\u5c31\u6d88\u5931\u4e86\uff0c\u771f\u5b9e\u5bf9\u8c61\u88ab\u56de\u6536\uff0c\u800c ",Object(r.b)("inlineCode",{parentName:"li"},"\u5f15\u7528")," \u5230 ",Object(r.b)("inlineCode",{parentName:"li"},"WeakReference")," \u7684\u5f15\u7528\u4f9d\u7136\u4fdd\u6301"),Object(r.b)("li",{parentName:"ul"},"\u5373 ",Object(r.b)("inlineCode",{parentName:"li"},"\u5f15\u7528 -> WeakReference\u5f31\u5f15\u7528 -> null")),Object(r.b)("li",{parentName:"ul"},"ThreadLocal \u4f7f\u7528\u5f31\u5f15\u7528\u4e3b\u8981\u662f\u4e3a\u4e86\u8ba9 ThreadLocal \u751f\u547d\u5468\u671f\u4e0e Thread \u751f\u547d\u5468\u671f\u89e3\u8026"))))),Object(r.b)("h2",{id:"threadlocal-\u5185\u5b58\u7ed3\u6784\u56fe"},"ThreadLocal \u5185\u5b58\u7ed3\u6784\u56fe"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"\u865a\u7ebf\u4e3a\u5f31\u5f15\u7528\u3001\u5b9e\u7ebf\u4e3a\u5f3a\u5f15\u7528"),Object(r.b)("li",{parentName:"ul"},"Entry \u7684 Key \u4e3a\u5f31\u5f15\u7528\uff0c\u6307\u5411 ThreadLocal \u5bf9\u8c61"),Object(r.b)("li",{parentName:"ul"},"Entry \u7684 Value \u4e3a\u5f3a\u5f15\u7528\uff0c\u6307\u5411\u5806\u5185\u5b58\u4e2d\u7684\u6570\u636e")),Object(r.b)("blockquote",null,Object(r.b)("ol",{parentName:"blockquote"},Object(r.b)("li",{parentName:"ol"},"\u6bcf\u4e2a Thread \u7ebf\u7a0b\u5185\u90e8\u6709\u4e00\u4e2a Map\uff1a",Object(r.b)("inlineCode",{parentName:"li"},"ThreadLocalMap")),Object(r.b)("li",{parentName:"ol"},"Map \u91cc\u9762\u5b58\u50a8 Entry \u5b9e\u4f53\uff0c\u662f\u4e00\u79cd ",Object(r.b)("inlineCode",{parentName:"li"},"key-value")," \u7ed3\u6784\uff0c\u5176\u4e2d ",Object(r.b)("strong",{parentName:"li"},"Key \u4e3a ThreadLocal \u5bf9\u8c61\uff1bValue \u662f\u7ebf\u7a0b\u53d8\u91cf\u526f\u672c")),Object(r.b)("li",{parentName:"ol"},"Thread \u5185\u90e8\u7684 Map \u662f\u7531 ThreadLocal \u7ef4\u62a4\u7684\uff0c\u7531 ThreadLocal \u8d1f\u8d23\u5411 Map \u83b7\u53d6\u548c\u8bbe\u7f6e\u7ebf\u7a0b\u7684\u53d8\u91cf\u503c"),Object(r.b)("li",{parentName:"ol"},"\u5bf9\u4e8e\u4e0d\u540c\u7684\u7ebf\u7a0b\uff0c\u6bcf\u6b21\u83b7\u53d6\u526f\u672c value \u503c\u65f6\uff0c\u522b\u7684\u7ebf\u7a0b\u5e76\u4e0d\u80fd\u83b7\u5f97\u5f53\u524d\u7ebf\u7a0b\u7684 value \u503c\uff0c\u5f62\u6210\u4e86\u526f\u672c\u7684\u9694\u79bb\uff0c\u4e92\u4e0d\u5e72\u6270"))),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},Object(r.b)("strong",{parentName:"p"},"\u8fd9\u6837\u8bbe\u8ba1\u7684\u597d\u5904")),Object(r.b)("ul",{parentName:"blockquote"},Object(r.b)("li",{parentName:"ul"},"\u6bcf\u4e2a Map \u5b58\u50a8\u7684 Entry \u6570\u76ee\u66f4\u5c11\uff0c\u964d\u4f4e\u54c8\u5e0c\u51b2\u7a81"),Object(r.b)("li",{parentName:"ul"},"\u5f53 Thread \u9500\u6bc1\u65f6\uff0cThreadLocalMap \u4e5f\u4f1a\u88ab\u9500\u6bc1"))),Object(r.b)("p",null,Object(r.b)("img",{alt:"image-20210524130127675",src:n(690).default})),Object(r.b)("h3",{id:"\u5185\u5b58\u6cc4\u6f0f"},"\u5185\u5b58\u6cc4\u6f0f"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"\u5f31\u5f15\u7528\u60c5\u51b5\u4e0b\uff1a\u5982\u679c\u4ee4 ",Object(r.b)("inlineCode",{parentName:"li"},"RESOURCE_1 = null")," \u5219\uff0cThreadLocal \u5bf9\u8c61\u4f1a\u88ab GC \u56de\u6536\uff0c\u4e24\u4e2a\u5f31\u5f15\u7528\u4ece ",Object(r.b)("inlineCode",{parentName:"li"},"Key<ThreadLocal>")," \u53d8\u4e3a ",Object(r.b)("inlineCode",{parentName:"li"},"Key<null>"),"\uff0c\u4f46\u6b64\u65f6 Entry \u4e2d\u7684 value \u8fd8\u6307\u5411\u7740\u5806\u4e2d\u7684\u6570\u636e\uff0c\u5c31\u53d1\u751f\u4e86 ",Object(r.b)("inlineCode",{parentName:"li"},"\u5185\u5b58\u6cc4\u6f0f"),Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"\u5f3a\u5f15\u7528\u60c5\u51b5\u4e0b\uff1aKey -> ThreadLocal \u7684\u5f15\u7528\u4f1a\u5bfc\u81f4 ThreadLocal \u4e0d\u80fd\u88ab\u56de\u6536")))),Object(r.b)("p",null,Object(r.b)("img",{alt:"image-20210524131328644",src:n(691).default})),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u901a\u8fc7 \u904d\u5386 ",Object(r.b)("inlineCode",{parentName:"li"},"KeySet")," \u627e\u5230 ",Object(r.b)("inlineCode",{parentName:"li"},"key == null"),"\uff0c\u7136\u540e\u628a\u5bf9\u5e94\u7684 ",Object(r.b)("inlineCode",{parentName:"li"},"value")," \u4e5f\u8bbe\u7f6e\u4e3a ",Object(r.b)("inlineCode",{parentName:"li"},"null")," \u5c31\u53ef\u4ee5\u5728 GC \u65f6\u56de\u6536\u5806\u7a7a\u95f4\uff0cThreadLocal \u7684 ",Object(r.b)("inlineCode",{parentName:"li"},"remove()")," \u65b9\u6cd5\u5b9e\u73b0\u4e86\u4e0a\u8ff0\u903b\u8f91")),Object(r.b)("h3",{id:"threadlocal-remove-\u65b9\u6cd5"},"ThreadLocal remove() \u65b9\u6cd5"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java",metastring:'title="remove() \u65b9\u6cd5"',title:'"remove()','\u65b9\u6cd5"':!0}),"/**\n* Removes the current thread's value for this thread-local\n* variable.  If this thread-local variable is subsequently\n* {@linkplain #get read} by the current thread, its value will be\n* reinitialized by invoking its {@link #initialValue} method,\n* unless its value is {@linkplain #set set} by the current thread\n* in the interim.  This may result in multiple invocations of the\n* {@code initialValue} method in the current thread.\n*\n* @since 1.5\n*/\npublic void remove() {\n    ThreadLocalMap m = getMap(Thread.currentThread());\n    if (m != null)\n        m.remove(this);\n}\n")),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"\u53c8\u8c03\u7528\u4e86 ",Object(r.b)("inlineCode",{parentName:"li"},"ThreadLocalMap")," \u7684 remove \u65b9\u6cd5\uff0c\u904d\u5386\u6240\u6709 Entry \u67e5\u770b key \u662f\u5426\u4e3a null\uff0c\u5176\u4e2d\u53c8\u8c03\u7528\u4e86 Entry \u7684 ",Object(r.b)("inlineCode",{parentName:"li"},"clear()")," \u65b9\u6cd5\uff0c\u4ee5\u53ca ",Object(r.b)("inlineCode",{parentName:"li"},"expungeStaleEntry(i)"))),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java",metastring:'title="ThreadLocalMap \u7684 remove \u65b9\u6cd5" {13}',title:'"ThreadLocalMap',"\u7684":!0,remove:!0,'\u65b9\u6cd5"':!0,"{13}":!0}),"/**\n * Remove the entry for key.\n */\nprivate void remove(ThreadLocal<?> key) {\n    Entry[] tab = table;\n    int len = tab.length;\n    int i = key.threadLocalHashCode & (len-1);\n    for (Entry e = tab[i];\n         e != null;\n         e = tab[i = nextIndex(i, len)]) {\n        if (e.get() == key) {\n            e.clear();\n            expungeStaleEntry(i);\n            return;\n        }\n    }\n}\n")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java",metastring:'title="expungeStaleEntry(i) \u65b9\u6cd5\u56de\u6536\u5931\u6548 Entry" {28-31}',title:'"expungeStaleEntry(i)',"\u65b9\u6cd5\u56de\u6536\u5931\u6548":!0,'Entry"':!0,"{28-31}":!0}),"/**\n* Expunge a stale entry by rehashing any possibly colliding entries\n* lying between staleSlot and the next null slot.  This also expunges\n* any other stale entries encountered before the trailing null.  See\n* Knuth, Section 6.4\n*\n* @param staleSlot index of slot known to have null key\n* @return the index of the next null slot after staleSlot\n* (all between staleSlot and this slot will have been checked\n* for expunging).\n*/\nprivate int expungeStaleEntry(int staleSlot) {\n    Entry[] tab = table;\n    int len = tab.length;\n\n    // expunge entry at staleSlot\n    tab[staleSlot].value = null;\n    tab[staleSlot] = null;\n    size--;\n\n    // Rehash until we encounter null\n    Entry e;\n    int i;\n    for (i = nextIndex(staleSlot, len);\n         (e = tab[i]) != null;\n         i = nextIndex(i, len)) {\n        ThreadLocal<?> k = e.get();\n        if (k == null) {\n            e.value = null; // \u5220\u9664 value \u7684\u5f3a\u5f15\u7528\n            tab[i] = null; // \u4ece ThreadLocalMap \u4e2d\u5220\u9664 Entry\n            size--;\n        } else {\n            int h = k.threadLocalHashCode & (len - 1);\n            if (h != i) {\n                tab[i] = null;\n\n                // Unlike Knuth 6.4 Algorithm R, we must scan until\n                // null because multiple entries could have been stale.\n                while (tab[h] != null)\n                    h = nextIndex(h, len);\n                tab[h] = e;\n            }\n        }\n    }\n    return i;\n}\n")),Object(r.b)("div",{className:"admonition admonition-info alert alert--info"},Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(r.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(r.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})))),"\u95ee\u9898")),Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(r.b)("p",{parentName:"div"},"\u770b\u8d77\u6765\uff0c\u5e94\u5f53\u624b\u52a8\u4f7f\u7528 remove() \u65b9\u6cd5\u56de\u6536\u7a7a\u95f4\uff0c\u5426\u5219\u5c31\u4f1a\u5185\u5b58\u6cc4\u6f0f\uff0c\u8fd9\u6837\u611f\u89c9\u6709\u70b9\u8822"),Object(r.b)("ul",{parentName:"div"},Object(r.b)("li",{parentName:"ul"},"\u5f88\u81ea\u7136\u7684\u6709\u4e00\u79cd\u60f3\u6cd5\uff0c\u5728 ",Object(r.b)("inlineCode",{parentName:"li"},"set")," \u65b0\u6570\u636e\u65f6\uff0c\u5bf9\u53ef\u4ee5\u88ab\u56de\u6536\u7684\u7a7a\u95f4\u8fdb\u884c\u56de\u6536"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"set")," \u65b9\u6cd5\u786e\u5b9e\u8fd9\u4e48\u505a\u4e86"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"get")," \u65b9\u6cd5\u5176\u5b9e\u4e5f\u5bf9\u7a7a\u95f4\u8fdb\u884c\u4e86\u56de\u6536")))),Object(r.b)("h3",{id:"set-\u65b9\u6cd5\u56de\u6536\u7a7a\u95f4"},"set \u65b9\u6cd5\u56de\u6536\u7a7a\u95f4"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"ThreadLocal \u7684 set \u65b9\u6cd5\u4e2d\u8c03\u7528\u4e86 ThreadLocalMap \u7684 set \u65b9\u6cd5")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java",metastring:'title="ThreadLocalMap \u7684 set \u65b9\u6cd5" {28,29}',title:'"ThreadLocalMap',"\u7684":!0,set:!0,'\u65b9\u6cd5"':!0,"{28,29}":!0}),"/**\n* Set the value associated with key.\n*\n* @param key the thread local object\n* @param value the value to be set\n*/\nprivate void set(ThreadLocal<?> key, Object value) {\n\n    // We don't use a fast path as with get() because it is at\n    // least as common to use set() to create new entries as\n    // it is to replace existing ones, in which case, a fast\n    // path would fail more often than not.\n\n    Entry[] tab = table;\n    int len = tab.length;\n    int i = key.threadLocalHashCode & (len-1);\n\n    for (Entry e = tab[i];\n         e != null;\n         e = tab[i = nextIndex(i, len)]) {\n        ThreadLocal<?> k = e.get();\n\n        if (k == key) {\n            e.value = value;\n            return;\n        }\n\n        if (k == null) { // \u5982\u679c key \u4e0d\u5b58\u5728\uff0c\u9700\u8981\u5360\u7528 Map \u7684\u65b0\u7a7a\u95f4\n            replaceStaleEntry(key, value, i); // \u627e\u5931\u6548\u7684Entry \u66ff\u6362\u5b83\u7684\u4f4d\u7f6e\n            return;\n        }\n    }\n\n    tab[i] = new Entry(key, value);\n    int sz = ++size;\n    if (!cleanSomeSlots(i, sz) && sz >= threshold)\n        rehash();\n}\n")),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"\u53ef\u4ee5\u770b\u5230\uff0c\u5982\u679c Key \u4e0d\u5b58\u5728\uff0c\u8868\u793a\u4f1a\u989d\u5916\u5360\u7528 Map \u7684\u7a7a\u95f4\uff0c\u90a3\u4e48\u5c1d\u8bd5\u66ff\u6362\u5df2\u7ecf\u5931\u6548\u7684 Entry \u5360\u7528\u7684\u7a7a\u95f4 ",Object(r.b)("inlineCode",{parentName:"li"},"replaceStaleEntry")," \u65b9\u6cd5\uff0c\u5176\u4e2d\u5c31\u8c03\u7528\u4e86 ",Object(r.b)("inlineCode",{parentName:"li"},"expungeStaleEntry")," \u65b9\u6cd5\u6e05\u9664\u5931\u6548\u7684 Entry")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java",metastring:'title="replaceStaleEntry \u65b9\u6cd5" {54,71}',title:'"replaceStaleEntry','\u65b9\u6cd5"':!0,"{54,71}":!0}),'/**\n* Replace a stale entry encountered during a set operation\n* with an entry for the specified key.  The value passed in\n* the value parameter is stored in the entry, whether or not\n* an entry already exists for the specified key.\n*\n* As a side effect, this method expunges all stale entries in the\n* "run" containing the stale entry.  (A run is a sequence of entries\n* between two null slots.)\n*\n* @param  key the key\n* @param  value the value to be associated with key\n* @param  staleSlot index of the first stale entry encountered while\n*         searching for key.\n*/\nprivate void replaceStaleEntry(ThreadLocal<?> key, Object value,\n                               int staleSlot) {\n    Entry[] tab = table;\n    int len = tab.length;\n    Entry e;\n\n    // Back up to check for prior stale entry in current run.\n    // We clean out whole runs at a time to avoid continual\n    // incremental rehashing due to garbage collector freeing\n    // up refs in bunches (i.e., whenever the collector runs).\n    int slotToExpunge = staleSlot;\n    for (int i = prevIndex(staleSlot, len);\n         (e = tab[i]) != null;\n         i = prevIndex(i, len))\n        if (e.get() == null)\n            slotToExpunge = i;\n\n    // Find either the key or trailing null slot of run, whichever\n    // occurs first\n    for (int i = nextIndex(staleSlot, len);\n         (e = tab[i]) != null;\n         i = nextIndex(i, len)) {\n        ThreadLocal<?> k = e.get();\n\n        // If we find key, then we need to swap it\n        // with the stale entry to maintain hash table order.\n        // The newly stale slot, or any other stale slot\n        // encountered above it, can then be sent to expungeStaleEntry\n        // to remove or rehash all of the other entries in run.\n        if (k == key) {\n            e.value = value;\n\n            tab[i] = tab[staleSlot];\n            tab[staleSlot] = e;\n\n            // Start expunge at preceding stale entry if it exists\n            if (slotToExpunge == staleSlot)\n                slotToExpunge = i;\n            cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);\n            return;\n        }\n\n        // If we didn\'t find stale entry on backward scan, the\n        // first stale entry seen while scanning for key is the\n        // first still present in the run.\n        if (k == null && slotToExpunge == staleSlot)\n            slotToExpunge = i;\n    }\n\n    // If key not found, put new entry in stale slot\n    tab[staleSlot].value = null;\n    tab[staleSlot] = new Entry(key, value);\n\n    // If there are any other stale entries in run, expunge them\n    if (slotToExpunge != staleSlot)\n        cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);\n}\n')),Object(r.b)("h3",{id:"get-\u65b9\u6cd5\u56de\u6536\u7a7a\u95f4"},"get \u65b9\u6cd5\u56de\u6536\u7a7a\u95f4"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"Get \u65b9\u6cd5\u8c03\u7528\u4e86 getEntry \u65b9\u6cd5")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java",metastring:'title="getEntry \u65b9\u6cd5"',title:'"getEntry','\u65b9\u6cd5"':!0}),"private Entry getEntry(ThreadLocal<?> key) {\n    int i = key.threadLocalHashCode & (table.length - 1);\n    Entry e = table[i];\n    if (e != null && e.get() == key)\n        return e;\n    else\n        return getEntryAfterMiss(key, i, e);\n}\n")),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"get \u65b9\u6cd5\u53c8\u8c03\u7528\u4e86 getEntryAfterMiss \u65b9\u6cd5\uff0c\u5176\u4e2d\u4f7f\u7528 enpungeStaleEntry \u5bf9\u7a7a\u95f4\u8fdb\u884c\u56de\u6536")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java",metastring:'title="getEntryAfterMiss" {10}',title:'"getEntryAfterMiss"',"{10}":!0}),"private Entry getEntryAfterMiss(ThreadLocal<?> key, int i, Entry e) {\n    Entry[] tab = table;\n    int len = tab.length;\n\n    while (e != null) {\n        ThreadLocal<?> k = e.get();\n        if (k == key)\n            return e;\n        if (k == null)\n            expungeStaleEntry(i);\n        else\n            i = nextIndex(i, len);\n        e = tab[i];\n    }\n    return null;\n}\n")),Object(r.b)("h3",{id:"\u5f31\u5f15\u7528\u53ef\u4ee5\u89e3\u51b3\u5185\u5b58\u6cc4\u6f0f\u95ee\u9898\u5417"},"\u5f31\u5f15\u7528\u53ef\u4ee5\u89e3\u51b3\u5185\u5b58\u6cc4\u6f0f\u95ee\u9898\u5417"),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},"\u53ea\u9760\u5f31\u5f15\u7528\u4e0d\u80fd\u89e3\u51b3\u5185\u5b58\u6cc4\u6f0f\u95ee\u9898"),Object(r.b)("ul",{parentName:"blockquote"},Object(r.b)("li",{parentName:"ul"},"\u901a\u8fc7\u5f31\u5f15\u7528\u53ea\u662f\u5b9e\u73b0\u4e86\u5bf9\u5931\u6548 Entry \u7684\u6807\u8bb0 \uff08key == null\uff09"),Object(r.b)("li",{parentName:"ul"},"\u8fd8\u9700\u8981\u627e\u5230\u8fd9\u4e9b Entry \u8fdb\u884c\u56de\u6536"))),Object(r.b)("h2",{id:"hash-\u8ba1\u7b97\u4e0e-hash-\u51b2\u7a81"},"Hash \u8ba1\u7b97\u4e0e Hash \u51b2\u7a81"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java",metastring:'title="ThreadLocalMap \u6784\u9020\u65b9\u6cd5" {5}',title:'"ThreadLocalMap','\u6784\u9020\u65b9\u6cd5"':!0,"{5}":!0}),"ThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {\n    //\u5e95\u5c42\u7ef4\u62a4Entry\u7684\u6570\u7ec4\n    table = new Entry[INITIAL_CAPACITY];\n    //\u8ba1\u7b97\u7d22\u5f15(\u91cd\u70b9\u4ee3\u7801\uff09\n    int i = firstKey.threadLocalHashCode & (INITIAL_CAPACITY - 1);\n    //\u8bbe\u7f6e\u503c\n    table[i] = new Entry(firstKey, firstValue);\n    size = 1;\n    //\u8bbe\u7f6e\u9608\u503c\n    setThreshold(INITIAL_CAPACITY);\n}\n")),Object(r.b)("h3",{id:"\u8ba1\u7b97\u7d22\u5f15"},"\u8ba1\u7b97\u7d22\u5f15"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java",metastring:'title="\u539f\u5b50\u6574\u578b\u3001HASH_INCREMENT\u3001\u54c8\u5e0c\u7b97\u6cd5"',title:'"\u539f\u5b50\u6574\u578b\u3001HASH_INCREMENT\u3001\u54c8\u5e0c\u7b97\u6cd5"'}),"private final int threadLocalHashCode = nextHashCode();\n\nprivate static int nextHashCode() {\n    return nextHashCode.getAndAdd(HASH_INCREMENT);\n}\n//AtomicInteger\u662f\u4e00\u4e2a\u63d0\u4f9b\u539f\u5b50\u64cd\u4f5c\u7684Integer\u7c7b\uff0c\u901a\u8fc7\u7ebf\u7a0b\u5b89\u5168\u7684\u65b9\u5f0f\u64cd\u4f5c\u52a0\u51cf,\u9002\u5408\u9ad8\u5e76\u53d1\u60c5\u51b5\u4e0b\u7684\u4f7f\u7528\nprivate static AtomicInteger nextHashCode =  new AtomicInteger();\n//\u7279\u6b8a\u7684hash\u503c\nprivate static final int HASH_INCREMENT = 0x61c88647;\n")),Object(r.b)("p",null,"\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2aAtomicInteger\u7c7b\u578b\uff0c\u6bcf\u6b21\u83b7\u53d6\u5f53\u524d\u503c\u5e76\u52a0\u4e0aHASH_INCREMENT\uff0cHASH_INCREMENT = 0x61c88647,\u8fd9\u4e2a\u503c\u8ddf\u6590\u6ce2\u90a3\u5951\u6570\u5217\uff08\u9ec4\u91d1\u5206\u5272\u6570\uff09\u6709\u5173\uff0c\u5176\u4e3b\u8981\u76ee\u7684\u5c31\u662f\u4e3a\u4e86\u8ba9\u54c8\u5e0c\u7801\u80fd\u5747\u5300\u7684\u5206\u5e03\u57282\u7684n\u6b21\u65b9\u7684\u6570\u7ec4\u91cc, \u4e5f\u5c31\u662fEntry[] table\u4e2d\uff0c\u8fd9\u6837\u505a\u53ef\u4ee5\u5c3d\u91cf\u907f\u514dhash\u51b2\u7a81"),Object(r.b)("p",null,"\u8ba1\u7b97hash\u7684\u65f6\u5019\u91cc\u9762\u91c7\u7528\u4e86 ",Object(r.b)("inlineCode",{parentName:"p"},"hashCode & (size - 1)")," \u7684\u7b97\u6cd5\uff0c\u8fd9\u76f8\u5f53\u4e8e\u53d6\u6a21\u8fd0\u7b97 ",Object(r.b)("inlineCode",{parentName:"p"},"hashCode % size")," \u7684\u4e00\u4e2a\u66f4\u9ad8\u6548\u7684\u5b9e\u73b0\u3002\u6b63\u662f\u56e0\u4e3a\u8fd9\u79cd\u7b97\u6cd5\uff0c\u6211\u4eec\u8981\u6c42size\u5fc5\u987b\u662f2\u7684\u6574\u6b21\u5e42\uff0c\u8fd9\u4e5f\u80fd\u4fdd\u8bc1\u5728\u7d22\u5f15\u4e0d\u8d8a\u754c\u7684\u524d\u63d0\u4e0b\uff0c\u4f7f\u5f97hash\u53d1\u751f\u51b2\u7a81\u7684\u6b21\u6570\u51cf\u5c0f\u3002"),Object(r.b)("h3",{id:"\u5f00\u653e\u5b9a\u5740\u6cd5\u7ebf\u6027\u63a2\u6d4b\u5904\u7406\u54c8\u5e0c\u51b2\u7a81"},"\u5f00\u653e\u5b9a\u5740\u6cd5\u2014\u2014\u7ebf\u6027\u63a2\u6d4b\u5904\u7406\u54c8\u5e0c\u51b2\u7a81"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"private void set(ThreadLocal<?> key, Object value) {\n\n    Entry[] tab = table;\n    int len = tab.length;\n    //\u4e0a\u6587\u8ba1\u7b97\u8fc7\u7684\u7d22\u5f15\n    int i = key.threadLocalHashCode & (len-1);\n    //\u7ebf\u6027\u63a2\u7d22\u7684\u8fc7\u7a0b\uff0c\u5faa\u73af\u63a2\u7d22\u627e\u5230\u5408\u9002\u7684\u5751\u4f4d\n    for (Entry e = tab[i];\n         e != null;\n         e = tab[i = nextIndex(i, len)]) {\n        ThreadLocal<?> k = e.get();\n        //ThreadLocal \u5bf9\u5e94\u7684 key \u5b58\u5728\uff0c\u76f4\u63a5\u8986\u76d6\u4e4b\u524d\u7684\u503c\n        if (k == key) {\n            e.value = value;\n            return;\n        }\n        // key\u4e3a null\uff0c\u4f46\u662fvalue\u4e0d\u4e3a null\uff0c\u8bf4\u660e\u4e4b\u524d\u7684 ThreadLocal \u5bf9\u8c61\u5df2\u7ecf\u88ab\u56de\u6536\u4e86\uff0c\n        // \u5f53\u524d\u6570\u7ec4\u4e2d\u7684 Entry \u662f\u4e00\u4e2a\u9648\u65e7\uff08stale\uff09\u7684\u5143\u7d20\n        if (k == null) {\n            //GC\u64cd\u4f5c\uff0c\u9632\u6b62\u5185\u5b58\u6cc4\u6f0f\uff0c\u540e\u6587\u8bb2\u5230\n            //\u5c06\u65b0\u503c\u66ff\u6362\u6389\u65e7\u503c\n            replaceStaleEntry(key, value, i);\n            return;\n        }\n    }\n    //\u5982\u679ckey\u4e3anull\uff0c\u4e5f\u6ca1\u6709\u65e7\u7684value\uff0c\u5c31\u65b0\u5efa\u4e00\u4e2aEntry\n    tab[i] = new Entry(key, value);\n    int sz = ++size;\n    /**\n    * cleanSomeSlots\u7528\u4e8e\u6e05\u9664\u90a3\u4e9be.get()==null\u7684\u5143\u7d20\uff0c\n    * \u8fd9\u79cd\u6570\u636ekey\u5173\u8054\u7684\u5bf9\u8c61\u5df2\u7ecf\u88ab\u56de\u6536\uff0c\u6240\u4ee5\u8fd9\u4e2aEntry(table[index])\u53ef\u4ee5\u88ab\u7f6enull\u3002\n    * \u5982\u679c\u6ca1\u6709\u6e05\u9664\u4efb\u4f55entry,\u5e76\u4e14\u5f53\u524d\u4f7f\u7528\u91cf\u8fbe\u5230\u4e86\u8d1f\u8f7d\u56e0\u5b50\u6240\u5b9a\u4e49(\u957f\u5ea6\u76842/3)\uff0c\u90a3\u4e48\u8fdb\u884c              rehash\uff08\u6267\u884c\u4e00\u6b21\u5168\u8868\u7684\u626b\u63cf\u6e05\u7406\u5de5\u4f5c\uff09\n    */\n    if (!cleanSomeSlots(i, sz) && sz >= threshold)\n        rehash();\n}\n\n/**\n* \u83b7\u53d6\u73af\u5f62\u6570\u7ec4\u7684\u4e0b\u4e00\u4e2a\u7d22\u5f15\n*/\nprivate static int nextIndex(int i, int len) {\n    return ((i + 1 < len) ? i + 1 : 0);\n}\n")),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"\u9996\u5148\u8fd8\u662f\u6839\u636ekey\u8ba1\u7b97\u51fa\u7d22\u5f15 i\uff0c\u7136\u540e\u67e5\u627ei\u4f4d\u7f6e\u4e0a\u7684Entry"),Object(r.b)("li",{parentName:"ol"},"\u82e5\u662fEntry\u5df2\u7ecf\u5b58\u5728\u5e76\u4e14key\u7b49\u4e8e\u4f20\u5165\u7684key\uff0c\u90a3\u4e48\u8fd9\u65f6\u5019\u76f4\u63a5\u7ed9\u8fd9\u4e2aEntry\u8d4b\u65b0\u7684value\u503c"),Object(r.b)("li",{parentName:"ol"},"\u82e5\u662fEntry\u5b58\u5728\uff0c\u4f46\u662fkey\u4e3anull\uff0c\u5219\u8c03\u7528replaceStaleEntry\u6765\u66f4\u6362\u8fd9\u4e2akey\u4e3a\u7a7a\u7684Entry"),Object(r.b)("li",{parentName:"ol"},"\u4e0d\u65ad\u5faa\u73af\u68c0\u6d4b\uff0c\u76f4\u5230\u9047\u5230\u4e3anull\u7684\u5730\u65b9\uff0c\u8fd9\u65f6\u5019\u8981\u662f\u8fd8\u6ca1\u5728\u5faa\u73af\u8fc7\u7a0b\u4e2dreturn\uff0c\u90a3\u4e48\u5c31\u5728\u8fd9\u4e2anull\u7684\u4f4d\u7f6e\u65b0\u5efa\u4e00\u4e2aEntry\uff0c\u5e76\u4e14\u63d2\u5165\uff0c\u540c\u65f6size\u589e\u52a01"),Object(r.b)("li",{parentName:"ol"},"\u6700\u540e\u8c03\u7528cleanSomeSlots\uff0c\u6e05\u7406key\u4e3anull\u7684Entry\uff0c\u6700\u540e\u8fd4\u56de\u662f\u5426\u6e05\u7406\u4e86Entry\uff0c\u63a5\u4e0b\u6765\u518d\u5224\u65ad sz \u662f\u5426>= thresgold\u8fbe\u5230\u4e86rehash\u7684\u6761\u4ef6\uff0c\u8fbe\u5230\u7684\u8bdd\u5c31\u4f1a\u8c03\u7528rehash\u51fd\u6570\u6267\u884c\u4e00\u6b21\u5168\u8868\u7684\u626b\u63cf\u6e05\u7406")),Object(r.b)("br",null),Object(r.b)("h1",{id:"spring-transaction-\u4e0e-threadlocal"},"Spring @Transaction \u4e0e ThreadLocal"),Object(r.b)("blockquote",null,Object(r.b)("ul",{parentName:"blockquote"},Object(r.b)("li",{parentName:"ul"},"\u901a\u8fc7 Spring \u7ba1\u7406\u6570\u636e\u5e93\u4e8b\u52a1\uff0c",Object(r.b)("inlineCode",{parentName:"li"},"\u4e00\u4e2a\u7ebf\u7a0b")," \u53d1\u8d77\u4e8b\u52a1\uff0c\u5728\u8fd9\u4e2a\u7ebf\u7a0b\u5185\u83b7\u53d6 ",Object(r.b)("inlineCode",{parentName:"li"},"\u6570\u636e\u5e93\u8fde\u63a5"),"\uff0c\u591a\u4e2a ",Object(r.b)("inlineCode",{parentName:"li"},"DAO"),"  \u5bf9 \u6570\u636e\u5e93\u8868\u8fdb\u884c\u64cd\u4f5c"),Object(r.b)("li",{parentName:"ul"},"\u5982\u679c\u81ea\u5df1\u5b9e\u73b0\u8fd9\u4e9b\u7684\u4ee3\u7801\uff0c\u76f4\u89c2\u7684\u60f3\u6cd5\u662f\u5728\u5404\u4e2a\u64cd\u4f5c\u6570\u636e\u5e93\u7684\u65b9\u6cd5\u4e4b\u95f4\uff0c\u4f20\u9012\u540c\u4e00\u4e2a Connection \u8fde\u63a5\u5bf9\u8c61\uff0c\u65e2\u7136\u5982\u6b64\uff0c\u4e0d\u5982\u628a Connection \u5bf9\u8c61\u5b58\u5230\u5f53\u524d\u7ebf\u7a0b\u91cc\uff0c\u7528\u5230\u7684\u65f6\u5019\u53d6\u51fa\u6765\uff0c\u800c\u4e0d\u662f\u5728\u65b9\u6cd5\u95f4\u4f20\u6765\u4f20\u53bb"),Object(r.b)("li",{parentName:"ul"},"@Transaction \u6ce8\u89e3\u5c31\u662f\u7528 ThreadLocal \u6765\u5b58\u50a8\u5f53\u524d\u6570\u636e\u5e93\u8fde\u63a5\u7684"))),Object(r.b)("br",null),Object(r.b)("h1",{id:"\u4f7f\u7528-threadlocal-\u7684\u573a\u666f"},"\u4f7f\u7528 ThreadLocal \u7684\u573a\u666f"),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},"\u5728\u4e00\u6b21 Request \u54cd\u5e94\u4e2d\uff0c\u4e0d\u4f7f\u7528\u591a\u7ebf\u7a0b\u7684\u60c5\u51b5\u4e0b\uff0c\u5c31\u662f\u7528\u4e00\u4e2a\u7ebf\u7a0b\u6765\u5b8c\u6210\u6574\u4e2a\u540e\u53f0\u903b\u8f91\u7684\uff0c\u90a3\u4e48\u4e00\u4e9b\u4fe1\u606f\u5c31\u53ef\u4ee5\u5b58\u50a8\u5728 ThreadLocal \u4e2d\uff0c\u5728\u6574\u4e2a Controller -> Service -> Dao \u4e4b\u95f4\u90fd\u53ef\u4ee5\u4f7f\u7528")),Object(r.b)("br",null),Object(r.b)("h1",{id:"\u9762\u8bd5\u9898"},"\u9762\u8bd5\u9898"),Object(r.b)("h2",{id:"1\u3001\u548csynchronized\u7684\u533a\u522b"},"1\u3001\u548cSynchronized\u7684\u533a\u522b"),Object(r.b)("p",null,"\u95ee\uff1a\u4ed6\u548c\u7ebf\u7a0b\u540c\u6b65\u673a\u5236\uff08\u5982\uff1aSynchronized\uff09\u63d0\u4f9b\u4e00\u6837\u7684\u529f\u80fd\uff0c\u8fd9\u4e2a\u5f88\u540a\u554a\u3002"),Object(r.b)("p",null,"\u7b54\uff1a\u653e\u5c41\uff01\u540c\u6b65\u673a\u5236\u4fdd\u8bc1\u7684\u662f\u591a\u7ebf\u7a0b\u540c\u65f6\u64cd\u4f5c\u5171\u4eab\u53d8\u91cf\u5e76\u4e14\u80fd\u6b63\u786e\u7684\u8f93\u51fa\u7ed3\u679c\u3002ThreadLocal\u4e0d\u884c\u554a\uff0c\u4ed6\u628a\u5171\u4eab\u53d8\u91cf\u53d8\u6210\u7ebf\u7a0b\u79c1\u6709\u4e86\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u6709\u72ec\u7acb\u7684\u4e00\u4e2a\u53d8\u91cf\u3002\u4e3e\u4e2a\u901a\u4fd7\u6613\u61c2\u7684\u6848\u4f8b\uff1a\u7f51\u7ad9\u8ba1\u6570\u5668\uff0c\u4f60\u7ed9\u53d8\u91cfcount++\u7684\u65f6\u5019\u5e26\u4e0asynchronized\u5373\u53ef\u89e3\u51b3\u3002ThreadLocal\u7684\u8bdd\u505a\u4e0d\u5230\u554a\uff0c\u4ed6\u6ca1\u53d1\u7edf\u8ba1\uff0c\u4ed6\u53ea\u80fd\u8bf4\u80fd\u7edf\u8ba1\u6bcf\u4e2a\u7ebf\u7a0b\u767b\u5f55\u4e86\u591a\u5c11\u6b21\u3002"),Object(r.b)("h2",{id:"2\u3001\u5b58\u50a8\u5728jvm\u7684\u54ea\u4e2a\u533a\u57df"},"2\u3001\u5b58\u50a8\u5728jvm\u7684\u54ea\u4e2a\u533a\u57df"),Object(r.b)("p",null,"\u95ee\uff1a\u7ebf\u7a0b\u79c1\u6709\uff0c\u90a3\u4e48\u5c31\u662f\u8bf4ThreadLocal\u7684\u5b9e\u4f8b\u548c\u4ed6\u7684\u503c\u662f\u653e\u5230\u6808\u4e0a\u54af\uff1f"),Object(r.b)("p",null,"\u7b54\uff1a\u4e0d\u662f\u3002\u8fd8\u662f\u5728\u5806\u7684\u3002ThreadLocal\u5bf9\u8c61\u4e5f\u662f\u5bf9\u8c61\uff0c\u5bf9\u8c61\u5c31\u5728\u5806\u3002\u53ea\u662fJVM\u901a\u8fc7\u4e00\u4e9b\u6280\u5de7\u5c06\u5176\u53ef\u89c1\u6027\u53d8\u6210\u4e86\u7ebf\u7a0b\u53ef\u89c1\u3002"),Object(r.b)("h2",{id:"3\u3001\u771f\u7684\u53ea\u662f\u5f53\u524d\u7ebf\u7a0b\u53ef\u89c1\u5417"},"3\u3001\u771f\u7684\u53ea\u662f\u5f53\u524d\u7ebf\u7a0b\u53ef\u89c1\u5417"),Object(r.b)("p",null,"\u95ee\uff1a\u771f\u7684\u53ea\u662f\u5f53\u524d\u7ebf\u7a0b\u53ef\u89c1\u5417\uff1f"),Object(r.b)("p",null,"\u7b54\uff1a\u8c8c\u4f3c\u4e0d\u662f\uff0c\u8c8c\u4f3c\u901a\u8fc7InheritableThreadLocal\u7c7b\u53ef\u4ee5\u5b9e\u73b0\u591a\u4e2a\u7ebf\u7a0b\u8bbf\u95eeThreadLocal\u7684\u503c\uff0c\u4f46\u662f\u6211\u6ca1\u7814\u7a76\u8fc7\uff0c\u77e5\u9053\u8fd9\u7801\u4e8b\u5c31\u884c\u4e86\u3002"),Object(r.b)("h2",{id:"4\u3001\u4f1a\u5bfc\u81f4\u5185\u5b58\u6cc4\u6f0f\u4e48"},"4\u3001\u4f1a\u5bfc\u81f4\u5185\u5b58\u6cc4\u6f0f\u4e48"),Object(r.b)("p",null,"\u95ee\uff1a\u4f1a\u5bfc\u81f4\u5185\u5b58\u6cc4\u6f0f\u4e48\uff1f"),Object(r.b)("p",null,"\u7b54\uff1a\u5206\u6790\u4e00\u4e0b\uff1a"),Object(r.b)("p",null,"1\u3001ThreadLocalMap.Entry\u7684key\u4f1a\u5185\u5b58\u6cc4\u6f0f\u5417\uff1f2\u3001ThreadLocalMap.Entry\u7684value\u4f1a\u5185\u5b58\u6cc4\u6f0f\u5417\uff1f\u5148\u770b\u4e0bkey-value\u7684\u6838\u5fc3\u6e90\u7801"),Object(r.b)("p",null,"staticclass Entry extends WeakReference<ThreadLocal<?>> { Object value; Entry(ThreadLocal<?> k, Object v) { super(k); value = v; }}"),Object(r.b)("p",null,"\u5148\u770b\u7ee7\u627f\u5173\u7cfb\uff0c\u53d1\u73b0\u662f\u7ee7\u627f\u4e86\u5f31\u5f15\u7528\uff0c\u800c\u4e14key\u76f4\u63a5\u662f\u4ea4\u7ed9\u4e86\u7236\u7c7b\u5904\u7406super(key)\uff0c\u7236\u7c7b\u662f\u4e2a\u5f31\u5f15\u7528\uff0c\u6240\u4ee5key\u5b8c\u5168\u4e0d\u5b58\u5728\u5185\u5b58\u6cc4\u6f0f\u95ee\u9898\uff0c\u56e0\u4e3a\u4ed6\u4e0d\u662f\u5f3a\u5f15\u7528\uff0c\u5b83\u53ef\u4ee5\u88abGC\u56de\u6536\u7684\u3002"),Object(r.b)("p",null,"\u5f31\u5f15\u7528\u7684\u7279\u70b9\uff1a\u5982\u679c\u8fd9\u4e2a\u5bf9\u8c61\u53ea\u88ab\u5f31\u5f15\u7528\u5173\u8054\uff0c\u6ca1\u6709\u4efb\u4f55\u5f3a\u5f15\u7528\u5173\u8054\uff0c\u90a3\u4e48\u8fd9\u4e2a\u5bf9\u8c61\u5c31\u53ef\u4ee5\u88abGC\u56de\u6536\u6389\u3002\u5f31\u5f15\u7528\u4e0d\u4f1a\u963b\u6b62GC\u56de\u6536\u3002\u8fd9\u662fjvm\u77e5\u8bc6\u3002"),Object(r.b)("p",null,"\u518d\u770bvalue\uff0c\u53d1\u73b0value\u662f\u4e2a\u5f3a\u5f15\u7528\uff0c\u4f46\u662f\u60f3\u4e86\u4e0b\u4e5f\u6ca1\u95ee\u9898\u7684\u5440\uff0c\u56e0\u4e3a\u7ebf\u7a0b\u7ec8\u6b62\u4e86\uff0c\u6211\u7ba1\u4f60\u5f3a\u5f15\u7528\u8fd8\u662f\u5f31\u5f15\u7528\uff0c\u90fd\u4f1a\u88abGC\u6389\u7684\uff0c\u56e0\u4e3a\u5f15\u7528\u94fe\u65ad\u4e86\uff08jvm\u7528\u7684\u53ef\u8fbe\u6027\u5206\u6790\u6cd5\uff0c\u7ebf\u7a0b\u7ec8\u6b62\u4e86\uff0c\u6839\u8282\u70b9\u5c31\u65ad\u4e86\uff0c\u4e0b\u9762\u7684\u90fd\u4f1a\u88ab\u56de\u6536\uff09\u3002"),Object(r.b)("p",null,"\u8fd9\u4e48\u5206\u6790\u4e00\u70b9\u6bdb\u75c5\u90fd\u6ca1\u6709\uff0c\u4f46\u662f\u5fd8\u4e86\u4e00\u4e2a\u4e3b\u8981\u7684\u89d2\u8272\uff0c\u90a3\u5c31\u662f",Object(r.b)("strong",{parentName:"p"},"\u7ebf\u7a0b\u6c60"),"\uff0c\u7ebf\u7a0b\u6c60\u7684\u5b58\u5728\u6838\u5fc3\u7ebf\u7a0b\u662f\u4e0d\u4f1a\u9500\u6bc1\u7684\uff0c\u53ea\u8981\u521b\u5efa\u51fa\u6765\u4ed6\u4f1a\u53cd\u590d\u5229\u7528\uff0c\u751f\u547d\u5468\u671f\u4e0d\u4f1a\u7ed3\u675f\u6389\uff0c\u4f46\u662fkey\u662f\u5f31\u5f15\u7528\u4f1a\u88abGC\u56de\u6536\u6389\uff0cvalue\u5f3a\u5f15\u7528\u4e0d\u4f1a\u56de\u6536\uff0c\u6240\u4ee5\u5f62\u6210\u4e86\u5982\u4e0b\u573a\u9762\uff1a"),Object(r.b)("p",null,"Thread->ThreadLocalMap->Entry(key\u4e3anull)->value"),Object(r.b)("p",null,"\u7531\u4e8evalue\u548cThread\u8fd8\u5b58\u5728\u94fe\u8def\u5173\u7cfb\uff0c\u8fd8\u662f\u53ef\u8fbe\u7684\uff0c\u6240\u4ee5\u4e0d\u4f1a\u88ab\u56de\u6536\uff0c\u8fd9\u6837\u8d8a\u6765\u8d8a\u591a\u7684\u5783\u573e\u5bf9\u8c61\u4ea7\u751f\u5374\u65e0\u6cd5\u56de\u6536\uff0c\u65e9\u6668\u5185\u5b58\u6cc4\u6f0f\uff0c\u65f6\u95f4\u4e45\u4e86\u5fc5\u5b9aOOM\u3002"),Object(r.b)("p",null,"\u89e3\u51b3\u65b9\u6848ThreadLocal\u5df2\u7ecf\u4e3a\u6211\u4eec\u60f3\u597d\u4e86\uff0c\u63d0\u4f9b\u4e86remove()\u65b9\u6cd5\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u662f\u5c06value\u79fb\u51fa\u53bb\u7684\u3002\u6240\u4ee5\u7528\u5b8c\u540e\u8bb0\u5f97remove()\u3002"),Object(r.b)("h2",{id:"5\u3001\u4e3a\u4ec0\u4e48\u7528entry\u6570\u7ec4\u800c\u4e0d\u662fentry\u5bf9\u8c61"},"5\u3001\u4e3a\u4ec0\u4e48\u7528Entry\u6570\u7ec4\u800c\u4e0d\u662fEntry\u5bf9\u8c61"),Object(r.b)("p",null,"\u8fd9\u4e2a\u5176\u5b9e\u4e3b\u8981\u60f3\u8003ThreadLocalMap\u662f\u5728Thread\u91cc\u6301\u6709\u7684\u5f15\u7528\u3002"),Object(r.b)("p",null,"\u95ee\uff1aThreadLocalMap\u5185\u90e8\u7684table\u4e3a\u4ec0\u4e48\u662f\u6570\u7ec4\u800c\u4e0d\u662f\u5355\u4e2a\u5bf9\u8c61\u5462\uff1f"),Object(r.b)("p",null,"\u7b54\uff1a\u56e0\u4e3a\u4f60\u4e1a\u52a1\u4ee3\u7801\u80fdnew\u597d\u591a\u4e2aThreadLocal\u5bf9\u8c61\uff0c\u5404\u53f8\u5176\u804c\u3002\u4f46\u662f\u5728\u4e00\u6b21\u8bf7\u6c42\u91cc\uff0c\u4e5f\u5c31\u662f\u4e00\u4e2a\u7ebf\u7a0b\u91cc\uff0cThreadLocalMap\u662f\u540c\u4e00\u4e2a\uff0c\u800c\u4e0d\u662f\u591a\u4e2a\uff0c\u4e0d\u7ba1\u4f60new\u51e0\u6b21ThreadLocal\uff0cThreadLocalMap\u5728\u4e00\u4e2a\u7ebf\u7a0b\u91cc\u5c31\u4e00\u4e2a\uff0c\u56e0\u4e3aThreadLocalMap\u7684\u5f15\u7528\u662f\u5728Thread\u91cc\u7684\uff0c\u6240\u4ee5\u5b83\u91cc\u9762\u7684Entry\u6570\u7ec4\u5b58\u653e\u7684\u662f\u4e00\u4e2a\u7ebf\u7a0b\u91cc\u4f60new\u51fa\u6765\u7684\u591a\u4e2aThreadLocal\u5bf9\u8c61\u3002"),Object(r.b)("h2",{id:"6\u3001\u4f60\u5b66\u4e60\u7684\u5f00\u6e90\u6846\u67b6\u54ea\u4e9b\u7528\u5230\u4e86threadlocal"},"6\u3001\u4f60\u5b66\u4e60\u7684\u5f00\u6e90\u6846\u67b6\u54ea\u4e9b\u7528\u5230\u4e86ThreadLocal"),Object(r.b)("p",null,"Spring\u6846\u67b6\u3002"),Object(r.b)("p",null,"DateTimeContextHolder"),Object(r.b)("p",null,"RequestContextHolder"),Object(r.b)("h2",{id:"7\u3001threadlocal\u91cc\u7684\u5bf9\u8c61\u4e00\u5b9a\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\u5417"},"7\u3001ThreadLocal\u91cc\u7684\u5bf9\u8c61\u4e00\u5b9a\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\u5417"),Object(r.b)("p",null,"\u672a\u5fc5\uff0c\u5982\u679c\u5728\u6bcf\u4e2a\u7ebf\u7a0b\u4e2dThreadLocal.set()\u8fdb\u53bb\u7684\u4e1c\u897f\u672c\u6765\u5c31\u662f\u591a\u7ebf\u7a0b\u5171\u4eab\u7684\u540c\u4e00\u4e2a\u5bf9\u8c61\uff0c\u6bd4\u5982static\u5bf9\u8c61\uff0c\u90a3\u4e48\u591a\u4e2a\u7ebf\u7a0b\u7684ThreadLocal.get()\u83b7\u53d6\u7684\u8fd8\u662f\u8fd9\u4e2a\u5171\u4eab\u5bf9\u8c61\u672c\u8eab\uff0c\u8fd8\u662f\u6709\u5e76\u53d1\u8bbf\u95ee\u7ebf\u7a0b\u4e0d\u5b89\u5168\u95ee\u9898\u3002"))}d.isMDXComponent=!0},570:function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return p}));var a=n(0),l=n.n(a);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,l=function(e,t){if(null==e)return{};var n,a,l={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(l[n]=e[n]);return l}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(l[n]=e[n])}return l}var b=l.a.createContext({}),d=function(e){var t=l.a.useContext(b),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},s=function(e){var t=d(e.components);return l.a.createElement(b.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return l.a.createElement(l.a.Fragment,{},t)}},u=l.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,i=e.parentName,b=o(e,["components","mdxType","originalType","parentName"]),s=d(n),u=a,p=s["".concat(i,".").concat(u)]||s[u]||h[u]||r;return n?l.a.createElement(p,c(c({ref:t},b),{},{components:n})):l.a.createElement(p,c({ref:t},b))}));function p(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=u;var c={};for(var o in t)hasOwnProperty.call(t,o)&&(c[o]=t[o]);c.originalType=e,c.mdxType="string"==typeof e?e:a,i[1]=c;for(var b=2;b<r;b++)i[b]=n[b];return l.a.createElement.apply(null,i)}return l.a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},690:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/16-16db1eac5645cb13c17e6d9057e24fc3.png"},691:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/17-d52e64b724df07480702b2cb5a36857f.png"}}]);